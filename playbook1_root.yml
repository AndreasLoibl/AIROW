---

- name: Update shinyservers
  hosts: shinyservers
  remote_user: "{{ superuser }}"
  become: yes
  tags: root_tasks

  tasks:

    - name: OS-Version
      ansible.builtin.debug:
        msg: ?? CentOS-7 ??? {{ inventory_hostname }} =
             {{ ansible_distribution }}-{{ ansible_distribution_major_version }}
      #when:
      #- ansible_distribution == 'CentOS'
      #- ansible_distribution_major_version == '7'

#    - name: end play if not centos7
#      ansible.builtin.meta: end_host
      #meta: end_host
#      when: ansible_facts['ansible_distribution'] == 'CentOS' and ansible_facts ['distribution_major_version'] != '7'

    - name: switch off setenforce temporarily
      command: setenforce 0
      tags: first

    - name:  switch off setenforce permanently (reboot)
      ansible.builtin.lineinfile:
        path: "/etc/sysconfig/selinux"
        regexp: 'SELINUX='
        line: "SELINUX=permissive"
        backrefs: yes
      tags: first

    - name: /etc/skel
      ansible.builtin.file:
        path: "/etc/skel/R/lib"
        state: directory
        mode: '0755'

    - name: /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        line: '{{ item }}'
        validate: /usr/sbin/visudo -cf %s
      with_items:
       #- 'root ALL=(ALL) ALL'
        - '{{ superuser}}      ALL=(ALL) ALL '
        - 'Cmnd_Alias SHINY_APP = /usr/bin/systemctl start shinyApp, /usr/bin/systemctl stop shinyApp, /usr/bin/systemctl status shinyApp'
        - '{{ developer}}      ALL=(ALL)  SHINY_APP'

    - name: system-wide  R_LIBS_USER (where user installs R packages)
      lineinfile:
        path: /etc/profile.d/shinyApp.sh
        line: '{{ item }}'
        state: present
        create: yes
      with_items:
        - export R_LIBS_USER="$HOME/R/lib"

    - name: Update all installed packages using YUM module
      yum:
        name: '*'
        state: latest
        update_cache: yes
        update_only: yes
      register: yum_update_status

    - name: Remove packages not needed anymore
      yum:
       autoremove: yes

    - name: Reboot when packages were updated
      reboot:
      when: yum_update_status.changed

    - name: Enable EPEL Repository on CentOS 7
      yum:
        name: epel-release
        state: latest
        #become: True
      when: ansible_facts['os_family'] == 'RedHat' and ansible_facts ['distribution_major_version'] == '7'


    - name: Install additional yum-packages in latest version
      yum:
        name: '{{yum_pkgs}}'
        state: latest
        update_cache: True
        #msg: {{ item }}

    - name: enable and start additional yum-pkgs as services_on_boot
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      when: "item in services_on_boot"
      with_items: '{{ services_on_boot }}'



    - name: copy system-script shinyApp
      ansible.builtin.copy:
        src:  src/etc-systemd-system-shinyApp.service
        dest: /etc/systemd/system/shinyApp.service
        owner: root
        group: root
        mode: '0644'
      tags: systemd

    - name: shinyApp.service runas {{ developer }}
      ansible.builtin.lineinfile:
        path: /etc/systemd/system/shinyApp.service
        regexp: '^User='
        line: "User={{ developer }}"
        backrefs: yes
      tags: systemd

    - name: set shinyApp.env vars
      lineinfile:
        path: /etc/systemd/system/shinyApp.env
        line: '{{ item }}'
        state: present
        create: yes
      with_items:
        - "# populated via playbook1:"
        - R_LIBS_USER=/home/{{ developer }}/R/lib
      tags: systemd

#    - name: Install Shiny-Server-pkg if wanted for sample demonstration
#      yum:
#        name: https://download3.rstudio.org/centos7/x86_64/shiny-server-1.5.17.973-x86_64.rpm
#        state: present



#    - name: run launch_Demo.R
#      script: /home/"{{ superuser }}"/ansible/launch_Demo.R \> \/dev\/tcp\/localhost\/4000 2\>\&1

    - name: enable shinyApp.services
      ansible.builtin.systemd:
        name: shinyApp.service
        # state: started -> userspace of {{developer}}
        enabled: yes
        daemon_reload: yes
      tags: systemd

#todo
# X11 forwarding


...
